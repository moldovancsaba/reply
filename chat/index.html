<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reply Hub v2</title>
  <style>
    :root {
      --primary: #007aff;
      --bg-sidebar: #1e1e1e;
      --bg-chat: #f5f5f7;
      --bg-kyc: #ffffff;
      --text-main: #1d1d1f;
      --text-dim: #86868b;
      --border: #e5e5e5;
      --status-draft: üü†;
      --status-open: üü¢;
      --status-closed: üîµ;
    }

    * {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-sidebar);
      color: white;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-list {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .load-more-btn {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: none;
      color: #888;
      font-size: 0.8rem;
      cursor: pointer;
      border-top: 1px solid #333;
      transition: background 0.2s;
    }

    .load-more-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #aaa;
    }

    .contact-item {
      padding: 1rem;
      border-bottom: 1px solid #333;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .contact-item:hover {
      background: #2c2c2e;
    }

    .contact-item.active {
      background: #3a3a3c;
    }

    .status-dot {
      font-size: 0.8rem;
    }

    .channel-icon {
      font-size: 1rem;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-preview {
      font-size: 0.8rem;
      color: #aaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat Area */
    .chat-area {
      background: var(--bg-chat);
      display: flex;
      flex-direction: column;
      position: relative;
      min-width: 0;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    .chat-header {
      padding: 1rem 1.5rem;
      background: white;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .messages-container {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
      /* Important for flex-grow with overflow */
    }

    .message-bubble {
      max-width: 85%;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.4;
      overflow-wrap: break-word;
      position: relative;
    }

    .message-info {
      font-size: 0.7rem;
      color: rgba(0, 0, 0, 0.4);
      margin-top: 4px;
      display: block;
    }

    .message-bubble.me .message-info {
      color: rgba(255, 255, 255, 0.7);
      text-align: right;
    }

    .message-bubble.me {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.contact {
      align-self: flex-start;
      background: white;
      color: var(--text-main);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .input-area {
      padding: 1.5rem;
      background: white;
      border-top: 1px solid var(--border);
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      background: #f0f0f2;
      padding: 8px;
      border-radius: 24px;
    }

    textarea#chat-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      padding: 8px 12px;
      resize: none;
      font-size: 0.95rem;
      max-height: 150px;
    }

    /* KYC Pane */
    .kyc-pane {
      background: var(--bg-kyc);
      padding: 1.5rem;
      border-left: 1px solid var(--border);
      overflow-y: auto;
      height: 100vh;
      max-height: 100vh;
    }

    .kyc-card {
      background: #f9f9fb;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }

    .kyc-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .kyc-value {
      font-size: 0.95rem;
      color: var(--text-main);
      margin-bottom: 1rem;
    }

    .kyc-notes {
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      width: 400px;
      padding: 2rem;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* Buttons */
    .btn {
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-ghost {
      background: transparent;
      color: var(--primary);
    }

    .btn-icon {
      background: transparent;
      padding: 4px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: grid;
      place-items: center;
    }

    .btn-icon:hover {
      background: #eee;
    }

    /* Dashboard Styles */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
      background: var(--bg-chat);
      height: 100%;
      overflow-y: auto;
    }

    .health-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .health-card h4 {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .health-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .health-status-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      width: fit-content;
    }

    .tag-online {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .tag-syncing {
      background: #e3f2fd;
      color: #1976d2;
    }

    .tag-warning {
      background: #fff3e0;
      color: #ef6c00;
    }

    /* Statuses */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.orange {
      background: #fff3e0;
      color: #e65100;
    }

    .status-badge.green {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- PANE A: SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div>
          <h2 style="margin:0; font-size: 1.1rem;">Reply Hub</h2>
          <div id="sync-status" style="font-size: 0.7rem; color: #888; margin-top: 4px;">Ready</div>
        </div>
        <!-- Sync buttons moved to individual cards -->
      </div>
      <div id="contact-list" class="contact-list">
        <!-- Contact Items will be injected here -->
        <div class="contact-item active">
          <span class="status-dot">üü†</span>
          <div class="contact-info">
            <div class="contact-name">Agneta</div>
            <div class="contact-preview">Draft ready: "Let's meet tomorrow..."</div>
          </div>
          <span class="channel-icon">üí¨</span>
        </div>
      </div>
    </aside>

    <!-- PANE B: MAIN CHAT -->
    <main class="chat-area">
      <header class="chat-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <div id="active-contact-name-chat" style="font-weight: 700; font-size: 1.1rem;">Select a contact</div>
          <select id="status-select" onchange="updateManualStatus()"
            style="font-size:0.8rem; border-radius:12px; border:1px solid #ddd; padding:2px 8px; cursor:pointer; display:none;">
            <option value="open">üü¢ Active</option>
            <option value="draft">üü† Draft Ready</option>
            <option value="closed">üîµ Resolved</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-ghost">Refine</button>
          <button class="btn btn-primary" id="btn-suggest">Suggest Draft</button>
        </div>
      </header>

      <div class="input-area" style="border-top:none; border-bottom:1px solid var(--border);">
        <div class="input-wrapper">
          <textarea id="chat-input" placeholder="Type a message or let me suggest..."></textarea>
          <button id="btn-mic" class="btn-icon" title="Voice Input">üé§</button>
          <button class="btn-icon">‚ú®</button>
          <button id="btn-send" class="btn btn-primary">Send iMessage</button>
        </div>
      </div>

      <div id="messages" class="messages-container">
        <button id="btn-load-older" class="load-more-btn"
          style="display:none; color:var(--text-dim); background:rgba(0,0,0,0.03); border-radius:12px; margin-bottom:1rem;"
          onclick="loadMoreMessages()">Load Older Messages</button>
        <!-- Messages will be injected here -->
      </div>

      <div id="dashboard" class="dashboard" style="display:none;">
        <!-- Dashboard items will be injected here -->
      </div>
    </main>

    <!-- PANE C: KYC DATA -->
    <section class="kyc-pane">
      <div id="kyc-empty-state" style="padding:20px; text-align:center;">
        <h3 style="color:var(--text-dim);">Hub Overview</h3>
        <p style="font-size:0.85rem; color:#888;">Select a contact from the sidebar to view their profile and history.
        </p>
        <div style="margin-top:40px; border-top:1px solid #eee; padding-top:20px;">
          <div style="font-size:0.7rem; font-weight:700; color:#ddd; text-transform:uppercase;">Quick Tip</div>
          <div style="font-size:0.85rem; color:#aaa; margin-top:8px;">You can search contacts by name or handle.</div>
        </div>
      </div>

      <div id="kyc-content-editor" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: baseline;">
          <h3 style="margin-top:0;">Profile</h3>
          <div style="display:flex; gap:5px;">
            <button id="btn-deep-analyze" class="btn-ghost" style="font-size:0.75rem; padding: 4px 8px;"
              title="Run Deep Analysis with Ollama">‚ú® Analyze</button>
            <button class="btn btn-primary" style="font-size:0.75rem; padding: 4px 8px;"
              onclick="saveInlineProfile()">Save Changes</button>
          </div>
        </div>
        <!-- KYC Cards follow... -->

        <div class="kyc-card">
          <div id="suggested-kyc-alert"
            style="display:none; background: #fff8e1; border: 1px solid #ffe082; border-radius: 6px; padding: 10px; margin-bottom: 1rem;">
            <div
              style="font-size: 0.75rem; font-weight: 700; color: #795548; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span>ü§ñ AI SUGGESTED UPDATE</span>
              <span onclick="dismissKYC()" style="cursor:pointer;" title="Dismiss">‚úï</span>
            </div>
            <div id="suggested-kyc-content" style="font-size: 0.85rem; color: #5d4037; font-style: italic;">
              <!-- Content injected via JS -->
            </div>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
              <button class="btn btn-primary" style="font-size: 0.7rem; padding: 3px 8px;" onclick="acceptKYC()">‚úÖ
                Accept</button>
              <button class="btn-ghost" style="font-size: 0.7rem; padding: 3px 8px;" onclick="editKYC()">üìù
                Edit</button>
            </div>
          </div>

          <div style="margin-bottom: 0.8rem;">
            <label style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Display Name</label>
            <input id="kyc-name-input"
              style="width:100%; border:none; border-bottom:1px solid transparent; font-weight:700; font-size:1rem; padding: 2px 0;"
              onfocus="this.style.borderBottom='1px solid var(--primary)'"
              onblur="this.style.borderBottom='1px solid transparent'">
          </div>

          <div style="margin-bottom: 0.8rem;">
            <label style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Profession</label>
            <input id="kyc-role-input"
              style="width:100%; border:none; border-bottom:1px solid transparent; font-size:0.9rem; padding: 2px 0;"
              onfocus="this.style.borderBottom='1px solid var(--primary)'"
              onblur="this.style.borderBottom='1px solid transparent'">
          </div>

          <div style="margin-bottom: 0.8rem;">
            <label style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Relationship</label>
            <input id="kyc-rel-input"
              style="width:100%; border:none; border-bottom:1px solid transparent; font-size:0.9rem; padding: 2px 0;"
              onfocus="this.style.borderBottom='1px solid var(--primary)'"
              onblur="this.style.borderBottom='1px solid transparent'">
          </div>

          <div style="margin-bottom: 0.8rem;">
            <label style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Handle</label>
            <input id="kyc-handle-input" readonly
              style="width:100%; border:none; font-size:0.8rem; color:#666; background:transparent;">
          </div>

          <div style="margin-top: 1.5rem;">
            <label style="font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight:700;">Local
              Intelligence
              (Notes Log)</label>
            <div id="notes-log"
              style="margin-top:0.5rem; max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 5px; background: #fff;">
              <!-- Notes injected here -->
            </div>
            <div style="margin-top: 0.8rem; display: flex; gap: 8px;">
              <input id="new-note-input" placeholder="Add a new observation..."
                style="flex:1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem;">
              <button class="btn-icon" onclick="addNote()"
                style="background: var(--primary); color: white; border: none; width: 30px; height: 30px;">+</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">Edit Contact Profile</h3>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Name:</label>
        <input id="prof-name" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Profession:</label>
        <input id="prof-role" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Relationship:</label>
        <input id="prof-rel" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="font-size:0.8rem; color:#666;">Notes:</label>
        <textarea id="prof-notes"
          style="width:100%; height:60px; padding:0.4rem; border:1px solid #ccc; border-radius:4px;"></textarea>
      </div>
      <input type="hidden" id="prof-handle">
      <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
        <button onclick="closeProfileModal()"
          style="background:#eee; color:#333; border:1px solid #ccc; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Cancel</button>
        <button onclick="saveProfile()"
          style="background:#056; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Save
          Profile</button>
      </div>
    </div>
  </div>

  <script>
    const contactListEl = document.getElementById("contact-list");
    const messagesEl = document.getElementById("messages");
    const chatInput = document.getElementById("chat-input");
    const activeNameEl = document.getElementById("active-contact-name");

    // KYC Elements
    // KYC Elements (Inline Editor)
    const kycNameInput = document.getElementById("kyc-name-input");
    const kycRoleInput = document.getElementById("kyc-role-input");
    const kycRelInput = document.getElementById("kyc-rel-input");
    const kycHandleInput = document.getElementById("kyc-handle-input");
    const kycNotesInput = document.getElementById("kyc-notes-input");

    let currentHandle = null;
    let contactOffset = 0;
    let messageOffset = 0;
    let conversations = []; // Global cache for contacts
    const CONTACT_LIMIT = 20;
    const MESSAGE_LIMIT = 30;

    /**
     * Fetch all conversations and render sidebar.
     */
    async function loadConversations(append = false) {
      if (!append) contactOffset = 0;

      try {
        const res = await fetch(`/api/conversations?limit=${CONTACT_LIMIT}&offset=${contactOffset}`);
        const data = await res.json();

        // Defensive: handle both old array format and new object format
        const contactsBatch = Array.isArray(data) ? data : (data.contacts || []);
        const hasMore = Array.isArray(data) ? false : (data.hasMore || false);

        if (!append) {
          contactListEl.innerHTML = "";
          conversations = [];
        }

        conversations = [...conversations, ...contactsBatch];

        // Remove existing load more button if present
        const oldBtn = document.getElementById("load-more-contacts");
        if (oldBtn) oldBtn.remove();

        contactsBatch.forEach(c => {
          const item = document.createElement("div");
          item.className = "contact-item" + (currentHandle === c.handle ? " active" : "");

          const status = c.status === "draft" ? "üü†" : (c.status === "open" ? "üü¢" : "üîµ");
          const channel = c.channel === "email" ? "üìß" : "üí¨";

          item.innerHTML = `
                    <span class="status-dot">${status}</span>
                    <div class="contact-info">
                        <div class="contact-name">${c.displayName}</div>
                        <div class="contact-preview">${c.lastMessage}</div>
                    </div>
                    <span class="channel-icon">${channel}</span>
                `;

          item.onclick = () => selectContact(c);
          contactListEl.appendChild(item);
        });

        if (hasMore) {
          const btn = document.createElement("button");
          btn.id = "load-more-contacts";
          btn.className = "load-more-btn";
          btn.textContent = "Load More Contacts...";
          btn.onclick = (e) => {
            e.stopPropagation();
            contactOffset += CONTACT_LIMIT;
            loadConversations(true);
          };
          contactListEl.appendChild(btn);
        }

        // If a contact is selected, we do NOT automatically refresh their messages here 
        // because it causes a double-fetch loop/race condition with selectContact.
        // refreshCurrentThread() should only be called by explicit user actions or polling interval if needed.
      } catch (e) {
        console.error("Failed to load conversations:", e);
      }
    }

    async function refreshCurrentThread() {
      if (!currentHandle) return;
      try {
        const res = await fetch(`/api/thread?handle=${encodeURIComponent(currentHandle)}&limit=${MESSAGE_LIMIT}&offset=0`);
        const data = await res.json();
        messageOffset = 0;
        renderMessages(data.messages, false, data.hasMore);
      } catch (e) {
        console.error("Failed to refresh thread:", e);
      }
    }

    async function loadMoreMessages() {
      if (!currentHandle) return;
      messageOffset += MESSAGE_LIMIT;
      try {
        const res = await fetch(`/api/thread?handle=${encodeURIComponent(currentHandle)}&limit=${MESSAGE_LIMIT}&offset=${messageOffset}`);
        const data = await res.json();
        renderMessages(data.messages, true, data.hasMore);
      } catch (e) {
        console.error("Failed to load more messages:", e);
      }
    }

    /**
     * Switch the active contact and load their thread + KYC.
     */
    async function selectContact(contact) {
      if (!contact) {
        currentHandle = null;
        document.getElementById("dashboard").style.display = "grid";
        document.getElementById("messages").style.display = "none";
        document.querySelector(".input-area").style.display = "none";
        document.getElementById("active-contact-name-chat").textContent = "Reply Hub Dashboard";
        document.getElementById("status-select").style.display = "none";
        document.getElementById("btn-suggest").style.display = "none";
        document.getElementById("kyc-empty-state").style.display = "block";
        document.getElementById("kyc-content-editor").style.display = "none";
        renderDashboard();
        return;
      }

      currentHandle = contact.handle;
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("messages").style.display = "flex";
      document.querySelector(".input-area").style.display = "block";
      document.getElementById("btn-suggest").style.display = "block";
      document.getElementById("kyc-empty-state").style.display = "none";
      document.getElementById("kyc-content-editor").style.display = "block";

      activeNameEl.textContent = contact.displayName;

      // Pre-fill draft if exists
      if (contact.draft) {
        chatInput.value = contact.draft;
        document.getElementById("active-contact-status").innerHTML = "üü† Draft Ready";
        document.getElementById("active-contact-status").className = "status-badge orange";
      } else {
        chatInput.value = "";
        document.getElementById("active-contact-status").innerHTML = "üü¢ Active";
        document.getElementById("active-contact-status").className = "status-badge green";
      }

      // Update Send Button text
      const isEmail = contact.handle && contact.handle.includes("@");
      document.getElementById("btn-send").textContent = isEmail ? "Send Email" : "Send iMessage";

      // Highlight in sidebar
      document.querySelectorAll(".contact-item").forEach(el => el.classList.remove("active"));

      // Update Name in Chat Header
      document.getElementById("active-contact-name-chat").textContent = contact.displayName;

      // Update Status Select
      const statusSelect = document.getElementById("status-select");
      statusSelect.value = contact.status || "open";
      statusSelect.style.display = "block";

      // Update KYC Pane (Inline Editor)
      document.getElementById("kyc-name-input").value = contact.displayName;
      document.getElementById("kyc-handle-input").value = contact.handle;
      document.getElementById("kyc-role-input").value = contact.profession || "";
      document.getElementById("kyc-rel-input").value = contact.relationship || "";

      // Render Notes Log
      renderNotes(contact.notes || []);

      // Show/Hide AI Recommendations
      const alertEl = document.getElementById("suggested-kyc-alert");
      const contentEl = document.getElementById("suggested-kyc-content");
      if (contact.pendingKYC) {
        let summary = [];
        if (contact.pendingKYC.profession) summary.push(`Profession: ${contact.pendingKYC.profession}`);
        if (contact.pendingKYC.relationship) summary.push(`Relationship: ${contact.pendingKYC.relationship}`);
        if (contact.pendingKYC.notes) summary.push(`Note: ${contact.pendingKYC.notes}`);

        contentEl.innerHTML = summary.join('<br>');
        alertEl.style.display = "block";
      } else {
        alertEl.style.display = "none";
      }

      // Load Messages
      try {
        const res = await fetch(`/api/thread?handle=${encodeURIComponent(contact.handle)}`);
        const data = await res.json();
        renderMessages(data.messages);
      } catch (e) {
        console.error("Failed to load thread:", e);
      }

      // Manually update active state in sidebar to avoid full reload
      document.querySelectorAll(".contact-item").forEach(el => {
        if (el.querySelector(".contact-name").textContent === contact.displayName) {
          el.classList.add("active");
        } else {
          el.classList.remove("active");
        }
      });
    }

    /**
     * Convert ISO date to relative time (e.g., "5m ago").
     */
    function timeAgo(dateString) {
      if (!dateString || dateString === "Unknown") return "";
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);

      if (seconds < 60) return "just now";
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    function renderMessages(msgs, prepend = false, hasMore = false) {
      if (!prepend) {
        // Keep the button but clear other children
        Array.from(messagesEl.children).forEach(child => {
          if (child.id !== 'btn-load-older') child.remove();
        });
      }

      document.getElementById("btn-load-older").style.display = hasMore ? "block" : "none";

      msgs.forEach(m => {
        const bubble = document.createElement("div");
        bubble.className = "message-bubble " + (m.role === "me" ? "me" : "contact");

        bubble.innerHTML = `
          ${m.text}
          <span class="message-info">${timeAgo(m.date)}</span>
        `;

        if (prepend) {
          // Find first message bubble (excluding button)
          const firstBubble = Array.from(messagesEl.children).find(c => c.id !== 'btn-load-older');
          if (firstBubble) {
            messagesEl.insertBefore(bubble, firstBubble);
          } else {
            messagesEl.appendChild(bubble); // Should unlikely happen if button exists
          }
        } else {
          messagesEl.appendChild(bubble);
        }
      });

      // Auto-scroll logic
      if (!prepend) {
        // New conversation load: scroll to bottom
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } else {
        // Prepend: maintain scroll position (complex, for now just let it be)
      }
    }

    // Polling for new messages/state (Live Feel)
    setInterval(loadConversations, 10000);

    // Initial Load + Auto Sync
    async function init() {
      await loadConversations();
      // Trigger a background sync on startup
      fetch("/api/sync-imessage", { method: "POST" });
      fetch("/api/sync-mail", { method: "POST" });
    }
    init();

    // Sync Handlers
    // Unified Sync Trigger
    async function triggerSync(type) {
      const statusEl = document.getElementById("sync-status");
      statusEl.textContent = `Syncing ${type}...`;

      try {
        let endpoint = `/api/sync-${type}`;
        const res = await fetch(endpoint, { method: "POST" });
        const data = await res.json();

        if (data.status === "started" || data.status === "ok") {
          statusEl.textContent = `${type} sync started.`;
          // Refresh conversations after a short delay
          setTimeout(() => loadConversations(), 2000);
        } else {
          statusEl.textContent = `Error: ${data.message || "Unknown"}`;
        }
      } catch (e) {
        statusEl.textContent = "Error triggering sync.";
        console.error(e);
      }
    }

    // Sync Handlers
    document.getElementById("sync-imessage-btn").onclick = () => triggerSync("imessage");
    document.getElementById("sync-whatsapp-btn").onclick = () => triggerSync("whatsapp");
    document.getElementById("sync-mail-btn").onclick = () => triggerSync("mail");

    // Wiring up Contacts Sync separately
    document.getElementById("sync-contacts-btn").onclick = async () => {
      const btn = document.getElementById("sync-contacts-btn");
      btn.disabled = true;
      const statusEl = document.getElementById("sync-status");
      statusEl.textContent = "Syncing Contacts...";
      try {
        const res = await fetch("/api/sync-contacts");
        const data = await res.json();
        statusEl.textContent = data.count ? `Synced ${data.count} contacts!` : "Contacts Synced!";
        loadConversations();
      } catch (e) {
        statusEl.textContent = "Sync failed.";
        console.error(e);
      }
      btn.disabled = false;
    };

    // Voice Handling
    const micBtn = document.getElementById("btn-mic");
    if ('webkitSpeechRecognition' in window) {
      const recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onstart = function () {
        micBtn.style.background = "#ffeba0";
        micBtn.classList.add("recording");
      };

      recognition.onend = function () {
        micBtn.style.background = "";
        micBtn.classList.remove("recording");
      };

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        const input = document.getElementById("chat-input");
        input.value = input.value ? input.value + " " + transcript : transcript;
        input.focus();
      };

      micBtn.onclick = function () {
        if (micBtn.classList.contains("recording")) {
          recognition.stop();
        } else {
          recognition.start();
        }
      };
    } else {
      if (micBtn) micBtn.style.display = "none";
    }

    // Wired up buttons

    document.getElementById("btn-suggest").onclick = async () => {
      if (!currentHandle) return alert("Select a contact first");
      const btn = document.getElementById("btn-suggest");
      btn.disabled = true;
      btn.textContent = "Analyzing...";

      try {
        const res = await fetch("/api/suggest-reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: "", context: "", recipient: currentHandle })
        });
        const data = await res.json();
        chatInput.value = data.reply;
      } catch (e) {
        alert("Suggestion failed: " + e.message);
      }
      btn.disabled = false;
      btn.textContent = "Suggest Draft";
    };

    // Profile Modal Logic
    window.closeProfileModal = function () {
      document.getElementById("profile-modal").style.display = "none";
    }

    window.saveInlineProfile = async function () {
      if (!currentHandle) return;

      // Before saving, also clear any pending KYC if we're hitting save (implies manual review)
      try {
        fetch(`/api/clear-pending-kyc?handle=${encodeURIComponent(currentHandle)}`, { method: 'POST' });
        const contact = conversations.find(c => c.handle === currentHandle);
        if (contact) delete contact.pendingKYC;
        document.getElementById("suggested-kyc-alert").style.display = "none";
      } catch (e) { }

      const data = {
        displayName: document.getElementById("kyc-name-input").value,
        profession: document.getElementById("kyc-role-input").value,
        relationship: document.getElementById("kyc-rel-input").value
        // REMOVED: notes overwrite here to prevent wiping log
      };

      try {
        const res = await fetch("/api/update-contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ handle: currentHandle, data })
        });
        const result = await res.json();
        if (result.status === "ok") {
          // Update local state in conversations list too to avoid mismatch on next select
          const contact = conversations.find(c => c.handle === currentHandle);
          if (contact) Object.assign(contact, result.contact);

          alert("Profile updated!");
          loadConversations(); // Re-render sidebar to reflect name changes
        } else {
          alert("Error: " + result.error);
        }
      } catch (e) {
        alert("Request failed: " + e.message);
      }
    }

    // Wiring up Deep Analyze
    document.getElementById("btn-deep-analyze").onclick = async () => {
      if (!currentHandle) return;
      const btn = document.getElementById("btn-deep-analyze");
      const originalText = btn.innerHTML; // Save icon

      btn.disabled = true;
      btn.innerHTML = `<span class="status-dot" style="animation: pulse 1s infinite">üîµ</span> Analyzing...`;

      try {
        const res = await fetch("/api/analyze-contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ handle: currentHandle })
        });
        const data = await res.json();

        if (data.status === "ok") {
          if (data.contact) {
            // Update local state
            const contact = conversations.find(c => c.handle === currentHandle);
            if (contact) Object.assign(contact, data.contact);

            // Refresh UI
            selectContact(contact);
            alert("Analysis Complete! Profile updated.");
          } else {
            alert(data.message || "Analysis ran but returned no new data.");
          }
        } else {
          alert("Analysis failed: " + data.error);
        }
      } catch (e) {
        alert("Error: " + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    };

    window.acceptKYC = function () {
      if (!currentHandle) return;
      const contact = conversations.find(c => c.handle === currentHandle);
      if (!contact || !contact.pendingKYC) return;

      if (contact.pendingKYC.profession) document.getElementById("kyc-role-input").value = contact.pendingKYC.profession;
      if (contact.pendingKYC.relationship) document.getElementById("kyc-rel-input").value = contact.pendingKYC.relationship;
      if (contact.pendingKYC.notes) {
        const currentNotes = document.getElementById("kyc-notes-input").value;
        document.getElementById("kyc-notes-input").value = currentNotes ? (currentNotes + "\n" + contact.pendingKYC.notes) : contact.pendingKYC.notes;
      }

      saveInlineProfile();
    }

    window.editKYC = function () {
      if (!currentHandle) return;
      const contact = conversations.find(c => c.handle === currentHandle);
      if (!contact || !contact.pendingKYC) return;

      if (contact.pendingKYC.profession) {
        document.getElementById("kyc-role-input").value = contact.pendingKYC.profession;
        document.getElementById("kyc-role-input").style.backgroundColor = "#fff9c4";
      }
      if (contact.pendingKYC.relationship) {
        document.getElementById("kyc-rel-input").value = contact.pendingKYC.relationship;
        document.getElementById("kyc-rel-input").style.backgroundColor = "#fff9c4";
      }
      if (contact.pendingKYC.notes) {
        const currentNotes = document.getElementById("kyc-notes-input").value;
        document.getElementById("kyc-notes-input").value = currentNotes ? (currentNotes + "\n" + contact.pendingKYC.notes) : contact.pendingKYC.notes;
        document.getElementById("kyc-notes-input").style.backgroundColor = "#fff9c4";
      }

      // Hide alert after clicking edit
      document.getElementById("suggested-kyc-alert").style.display = "none";
    }

    window.dismissKYC = async function () {
      if (!currentHandle) return;
      try {
        await fetch(`/api/clear-pending-kyc?handle=${encodeURIComponent(currentHandle)}`, { method: 'POST' });
        const contact = conversations.find(c => c.handle === currentHandle);
        if (contact) delete contact.pendingKYC;
        document.getElementById("suggested-kyc-alert").style.display = "none";
      } catch (e) {
        alert("Failed to dismiss suggestion: " + e.message);
      }
    }

    window.updateManualStatus = async function () {
      if (!currentHandle) return;
      const status = document.getElementById("status-select").value;
      try {
        await fetch("/api/update-status", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ handle: currentHandle, status })
        });
        const contact = conversations.find(c => c.handle === currentHandle);
        if (contact) contact.status = status;
        loadConversations();
      } catch (e) {
        alert("Status update failed: " + e.message);
      }
    }

    window.renderNotes = function (notes) {
      const log = document.getElementById("notes-log");
      log.innerHTML = "";

      if (!notes || notes.length === 0) {
        log.innerHTML = `<div style="padding:10px; color:#999; text-align:center; font-size:0.8rem;">No observations recorded yet.</div>`;
        return;
      }

      // Sort newest first
      const sorted = [...notes].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      sorted.forEach(n => {
        const date = new Date(n.timestamp).toLocaleString([], { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const item = document.createElement("div");
        item.className = "note-item";
        item.style = "padding: 8px; border-bottom: 1px solid #f0f0f0; position: relative;";
        item.innerHTML = `
                <div style="font-size: 0.7rem; color: #888; margin-bottom: 2px;">${date}</div>
                <div style="font-size: 0.85rem; color: #333; line-height: 1.4;">${n.text}</div>
                <span onclick="deleteNote('${n.id}')" style="position: absolute; top: 8px; right: 8px; cursor: pointer; color: #ddd; font-size: 0.8rem;" title="Delete">‚úï</span>
            `;
        log.appendChild(item);
      });
    }

    window.addNote = async function () {
      if (!currentHandle) return;
      const input = document.getElementById("new-note-input");
      const text = input.value.trim();
      if (!text) return;

      try {
        const res = await fetch("/api/add-note", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ handle: currentHandle, text })
        });
        if (res.ok) {
          input.value = "";
          // Refresh local state and re-render
          await loadConversations();
          const contact = conversations.find(c => c.handle === currentHandle);
          if (contact) renderNotes(contact.notes);
        }
      } catch (e) {
        alert("Failed to add note: " + e.message);
      }
    }

    window.deleteNote = async function (id) {
      if (!currentHandle || !confirm("Delete this observation?")) return;
      try {
        const res = await fetch(`/api/delete-note?handle=${encodeURIComponent(currentHandle)}&id=${id}`, { method: 'POST' });
        if (res.ok) {
          await loadConversations();
          const contact = conversations.find(c => c.handle === currentHandle);
          if (contact) renderNotes(contact.notes);
        }
      } catch (e) {
        alert("Failed to delete note: " + e.message);
      }
    }

    window.renderDashboard = async function () {
      const dashboard = document.getElementById("dashboard");
      dashboard.innerHTML = `<div style="padding:40px; color:#666;">Loading system health...</div>`;

      try {
        const res = await fetch("/api/system-health");
        const health = await res.json();

        // Use iMessage channel as primary sync indicator
        const syncState = health.channels?.imessage || {};
        const lastSync = syncState.lastSync ? new Date(syncState.lastSync).toLocaleString() : "Never";

        const uptimeHrs = (health.uptime / 3600).toFixed(1);

        dashboard.innerHTML = `
                <div class="health-card">
                    <h4>System Status</h4>
                    <div class="health-value">Online</div>
                    <div class="health-status-tag tag-online">‚óè Server Running</div>
                    <div style="font-size:0.8rem; color:#888;">Uptime: ${uptimeHrs} hours</div>
                </div>
                
                <!-- iMessage Card -->
                <div class="health-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>iMessage Sync</h4>
                        <button class="btn-icon" title="Sync iMessage" onclick="triggerSync('imessage')">üí¨</button>
                    </div>
                    <div class="health-value">${syncState.processed || 0}</div>
                    <div class="health-status-tag ${syncState.state === 'running' ? 'tag-warning' : 'tag-syncing'}">
                        ${syncState.state === 'running' ? '‚ö°Ô∏è Syncing...' : '‚óè Messages Scanned'}
                    </div>
                    <div style="font-size:0.8rem; color:#888;">Last Sync: ${lastSync}</div>
                </div>

                <!-- WhatsApp Card -->
                <div class="health-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>WhatsApp Sync</h4>
                        <button class="btn-icon" title="Sync WhatsApp" onclick="triggerSync('whatsapp')">üì±</button>
                    </div>
                    <div class="health-value">${health.channels?.whatsapp?.processed || 0}</div>
                    <div class="health-status-tag ${health.channels?.whatsapp?.state === 'running' ? 'tag-warning' : 'tag-syncing'}">
                        ${health.channels?.whatsapp?.state === 'running' ? '‚ö°Ô∏è Syncing...' : '‚óè Messages Scanned'}
                    </div>
                    <div style="font-size:0.8rem; color:#888;">
                        Last Sync: ${health.channels?.whatsapp?.lastSync ? new Date(health.channels.whatsapp.lastSync).toLocaleString() : "Never"}
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="health-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>Apple Notes</h4>
                        <button class="btn-icon" title="Sync Notes" onclick="triggerSync('notes')">üìù</button>
                    </div>
                     <div class="health-value">${health.channels?.notes?.total || 0}</div>
                    <div class="health-status-tag ${health.channels?.notes?.state === 'running' ? 'tag-warning' : 'tag-syncing'}">
                        ${health.channels?.notes?.state === 'running' ? '‚ö°Ô∏è Indexing...' : '‚óè Notes Indexed'}
                    </div>
                    <div style="font-size:0.8rem; color:#888;">
                        Last Sync: ${health.channels?.notes?.lastSync ? new Date(health.channels.notes.lastSync).toLocaleString() : "Never"}
                    </div>
                </div>
                
                <div class="health-card" style="grid-column: span 2;">
                    <h4>Auto-Triage Log</h4>
                    <div id="triage-log-list" style="font-size:0.8rem; color:#555; max-height:100px; overflow-y:auto;">
                        loading...
                    </div>
                </div>
            `;
      } catch (e) {
        dashboard.innerHTML = `<div style="padding:40px; color:red;">Failed to load health metrics: ${e.message}</div>`;
      }

      // Fetch Triage Logs separately
      try {
        const res = await fetch("/api/triage-log");
        const data = await res.json();
        const logList = document.getElementById("triage-log-list");
        if (logList && data.logs && data.logs.length > 0) {
          logList.innerHTML = data.logs.map(l => `
                <div style="border-bottom:1px solid #eee; padding:4px 0;">
                    <span style="font-weight:700; color:#555;">[${l.tag}]</span> 
                    ${l.action.toUpperCase()} - ${l.sender}: "${l.preview}"
                    <span style="color:#aaa; font-size:0.7rem;">${new Date(l.timestamp).toLocaleTimeString()}</span>
                </div>
              `).join('');
        } else if (logList) {
          logList.innerHTML = "<div style='color:#999; font-style:italic;'>No recent triage actions.</div>";
        }
      } catch (e) {
        console.error("Failed to load triage logs", e);
      }
    }

    // Initial Load
    loadConversations();
    selectContact(null);
    document.getElementById("btn-send").onclick = async () => {
      const text = chatInput.value.trim();
      if (!text || !currentHandle) return;

      const isEmail = currentHandle && currentHandle.includes("@");
      const endpoint = isEmail ? "/api/send-email" : "/api/send-imessage";
      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ recipient: currentHandle, text })
        });
        const data = await res.json();
        if (data.status === "ok") {
          chatInput.value = "";
          // Optimistically add to messages at TOP
          const bubble = document.createElement("div");
          bubble.className = "message-bubble me";
          bubble.textContent = text;
          messagesEl.prepend(bubble);
          messagesEl.scrollTop = 0;
        } else {
          alert("Send failed: " + data.error);
        }
      } catch (e) {
        alert("Error: " + e.message);
      }
    };
  </script>
</body>

</html>