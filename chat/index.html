<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{reply}</title>
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body>
  <div class="app-container">
    <!-- PANE A: SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="material-symbols-outlined" style="font-size: 28px; color: var(--text-primary); cursor: pointer;"
            onclick="window.selectContact(null)" title="Go to Dashboard">
            flip_camera_android
          </span>
          <span class="material-symbols-outlined" style="font-size: 24px; color: var(--text-primary); cursor: pointer;"
            onclick="window.openSettings()" title="Settings">
            settings
          </span>
        </div>
        <div id="sync-status" title="Sync Status">
          <span class="status-dot active"></span>
        </div>
        <!-- Sync buttons moved to individual cards -->
      </div>
      <div id="contact-list" class="contact-list">
        <!-- Contact Items will be injected here -->
        <div class="contact-item active">
          <span class="status-dot">ðŸŸ </span>
          <div class="contact-info">
            <div class="contact-name">Agneta</div>
            <div class="contact-preview">Draft ready: "Let's meet tomorrow..."</div>
          </div>
          <span class="channel-icon">ðŸ’¬</span>
        </div>
      </div>
    </aside>

    <!-- PANE B: MAIN CHAT -->
    <main class="chat-area">
      <header class="chat-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <div id="active-contact-name-chat" style="font-weight: 700; font-size: 1.1rem;">Select a contact</div>
          <select id="status-select" onchange="updateManualStatus()"
            style="font-size:0.8rem; border-radius:12px; border:1px solid #ddd; padding:2px 8px; cursor:pointer; display:none;">
            <option value="open">ðŸŸ¢ Active</option>
            <option value="draft">ðŸŸ  Draft Ready</option>
            <option value="closed">ðŸ”µ Resolved</option>
          </select>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-primary" id="btn-mic" title="Voice Input" style="display:none;">ðŸŽ¤ Mic</button>
          <button class="btn btn-primary" id="btn-magic" title="Instant Polish" style="display:none;">âœ¨ Magic</button>
          <button class="btn btn-primary" id="btn-suggest" style="display:none;">ðŸ’¡ Suggest</button>
        </div>
      </header>

      <div class="input-area" style="border-top:none; border-bottom:1px solid var(--border);">
        <div class="input-wrapper">
          <textarea id="chat-input" rows="1" placeholder="Type a message..."></textarea>
          <select id="channel-select" class="channel-select" title="Channel">
            <option value="imessage">iMessage</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="email">Email</option>
          </select>
          <button id="btn-send" class="btn btn-primary">Send</button>
        </div>
      </div>

      <div id="messages" class="messages-container">
        <!-- Messages will be injected here -->
      </div>

      <div id="dashboard" class="dashboard" style="display:none;">
        <!-- Dashboard items will be injected here -->
      </div>

      <!-- Settings Page -->
      <div id="settings-page" class="settings-page" style="display:none;">
        <div class="settings-page-shell">
	          <div class="settings-page-topbar">
	            <div>
	              <div class="settings-page-title">Settings</div>
	              <div class="settings-page-subtitle">Local-only configuration for this machine</div>
	            </div>
	            <div class="settings-page-actions">
	              <button id="settings-close" class="btn btn-secondary btn-sm">Back</button>
	              <button id="settings-save" class="btn btn-primary btn-sm">Save</button>
	            </div>
	          </div>

	          <div class="settings-services">
	            <div class="settings-services-label">Configure a service:</div>
	            <div class="settings-services-actions">
	              <button type="button" class="btn btn-secondary btn-sm" onclick="window.openChannelSettings('imessage')">iMessage</button>
	              <button type="button" class="btn btn-secondary btn-sm" onclick="window.openChannelSettings('whatsapp')">WhatsApp</button>
	              <button type="button" class="btn btn-secondary btn-sm" onclick="window.openChannelSettings('email')">Email</button>
	              <button type="button" class="btn btn-secondary btn-sm" onclick="window.openChannelSettings('notes')">Notes</button>
	            </div>
	          </div>

	          <div id="settings-filter-bar" class="settings-filter-bar" style="display:none;">
	            <div id="settings-filter-label" class="settings-filter-label">Configuring</div>
	            <button id="settings-show-all" class="btn btn-ghost btn-sm">General Settings</button>
	          </div>

          <div id="settings-modal-scroll" class="settings-page-scroll">
            <div id="settings-channel-mail" style="margin-top: 0.5rem;">
              <div style="font-size:0.75rem; font-weight:700; color:#888; text-transform:uppercase; margin-bottom: 10px;">Email (IMAP / Gmail)</div>

              <div style="display:grid; grid-template-columns: 1fr 120px; gap: 10px;">
                <div>
                  <label style="font-size:0.8rem; color:#666;">Host</label>
                  <input id="settings-imap-host" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="imap.gmail.com">
                </div>
                <div>
                  <label style="font-size:0.8rem; color:#666;">Port</label>
                  <input id="settings-imap-port" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="993">
                </div>
              </div>

              <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <input id="settings-imap-secure" type="checkbox" checked>
                <label for="settings-imap-secure" style="font-size:0.85rem; color:#666;">Use TLS</label>
              </div>

              <div style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">Username</label>
                <input id="settings-imap-user" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="you@gmail.com">
              </div>

              <div style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">Password (Gmail: App Password)</label>
                <input id="settings-imap-pass" type="password" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="Leave blank to keep existing">
                <div id="settings-imap-pass-hint" style="font-size:0.75rem; color:#999; margin-top:6px;">Not set</div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                <div>
                  <label style="font-size:0.8rem; color:#666;">Mailbox</label>
                  <input id="settings-imap-mailbox" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="INBOX">
                </div>
                <div>
                  <label style="font-size:0.8rem; color:#666;">Sent Mailbox (optional)</label>
                  <input id="settings-imap-sent-mailbox" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="[Gmail]/Sent Mail">
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                <div>
                  <label style="font-size:0.8rem; color:#666;">Fetch limit / run</label>
                  <input id="settings-imap-limit" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="200">
                </div>
                <div>
                  <label style="font-size:0.8rem; color:#666;">First-run lookback (days)</label>
                  <input id="settings-imap-since-days" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="30">
                </div>
              </div>

              <div style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">Self emails (comma-separated, optional)</label>
                <input id="settings-self-emails" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="me@domain.com, alias@domain.com">
              </div>

              <div style="font-size:0.75rem; color:#999; margin-top:10px;">
                Stored locally on this machine (not encrypted). Use an App Password for Gmail.
              </div>
            </div>

            <div id="settings-channel-gmail" style="margin-top: 1.25rem; border-top: 1px solid #eee; padding-top: 1rem;">
              <div style="font-size:0.75rem; font-weight:700; color:#888; text-transform:uppercase; margin-bottom: 10px;">Gmail (OAuth)</div>

              <div style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">OAuth Client ID</label>
                <input id="settings-gmail-client-id" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="xxxx.apps.googleusercontent.com">
              </div>

              <div style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">OAuth Client Secret</label>
                <input id="settings-gmail-client-secret" type="password" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" placeholder="Leave blank to keep existing">
                <div id="settings-gmail-client-secret-hint" style="font-size:0.75rem; color:#999; margin-top:6px;">Not set</div>
              </div>

              <div id="settings-gmail-status" style="font-size:0.85rem; color:#666; margin-top:10px;">Not connected</div>

              <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 12px;">
                <button id="settings-gmail-disconnect" class="btn btn-ghost" style="padding: 8px 12px;">Disconnect</button>
                <button id="settings-gmail-connect" class="btn btn-primary" style="padding: 8px 12px;">Connect Gmail</button>
              </div>

              <div style="font-size:0.75rem; color:#999; margin-top:10px;">
                Redirect URI must be registered in Google Cloud Console (usually `http://localhost:3000/api/gmail/oauth-callback`).
              </div>
            </div>

            <div id="settings-section-worker" style="margin-top: 1.25rem; border-top: 1px solid #eee; padding-top: 1rem;">
              <div style="font-size:0.75rem; font-weight:700; color:#888; text-transform:uppercase; margin-bottom: 10px;">Background Worker</div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div id="settings-worker-interval-wrap">
                  <label style="font-size:0.8rem; color:#666;">Poll interval (seconds)</label>
                  <input id="settings-worker-interval" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="60">
                </div>
                <div id="settings-worker-gmail-wrap">
                  <label style="font-size:0.8rem; color:#666;">Gmail max / run</label>
                  <input id="settings-worker-gmail-max" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="100">
                </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                <div id="settings-worker-imessage-wrap">
                  <label style="font-size:0.8rem; color:#666;">iMessage max / run</label>
                  <input id="settings-worker-imessage-max" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="1000">
                </div>
                <div id="settings-worker-whatsapp-wrap">
                  <label style="font-size:0.8rem; color:#666;">WhatsApp max / run</label>
                  <input id="settings-worker-whatsapp-max" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="500">
                </div>
              </div>

              <div id="settings-channel-notes" style="margin-top:10px;">
                <label style="font-size:0.8rem; color:#666;">Notes max / run (0 = unlimited)</label>
                <input id="settings-worker-notes-max" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;" value="0">
              </div>
            </div>

            <div id="settings-section-ui" style="margin-top: 1.25rem; border-top: 1px solid #eee; padding-top: 1rem;">
              <div style="font-size:0.75rem; font-weight:700; color:#888; text-transform:uppercase; margin-bottom: 10px;">Channel UI</div>

              <div style="display:grid; grid-template-columns: 1fr; gap: 12px;">
                <div id="settings-channel-imessage" style="border:1px solid #eee; border-radius: 12px; padding: 12px;">
                  <div style="font-weight:700; color:#444; margin-bottom:10px;">iMessage</div>
                  <div style="display:grid; grid-template-columns: 120px 1fr 1fr; gap: 10px; align-items:end;">
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Emoji</label>
                      <input id="settings-ui-imessage-emoji" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">My bubble</label>
                      <input id="settings-ui-imessage-me" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Their bubble</label>
                      <input id="settings-ui-imessage-contact" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                  </div>
                </div>

                <div id="settings-channel-whatsapp" style="border:1px solid #eee; border-radius: 12px; padding: 12px;">
                  <div style="font-weight:700; color:#444; margin-bottom:10px;">WhatsApp</div>
                  <div style="display:grid; grid-template-columns: 120px 1fr 1fr; gap: 10px; align-items:end;">
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Emoji</label>
                      <input id="settings-ui-whatsapp-emoji" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">My bubble</label>
                      <input id="settings-ui-whatsapp-me" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Their bubble</label>
                      <input id="settings-ui-whatsapp-contact" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                  </div>
                </div>

                <div id="settings-channel-email" style="border:1px solid #eee; border-radius: 12px; padding: 12px;">
                  <div style="font-weight:700; color:#444; margin-bottom:10px;">Email</div>
                  <div style="display:grid; grid-template-columns: 120px 1fr 1fr; gap: 10px; align-items:end;">
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Emoji</label>
                      <input id="settings-ui-email-emoji" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:8px;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">My bubble</label>
                      <input id="settings-ui-email-me" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                    <div>
                      <label style="font-size:0.8rem; color:#666;">Their bubble</label>
                      <input id="settings-ui-email-contact" type="color" style="width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding: 0;">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-page-footer">
            <div style="font-size:0.75rem; color:#999;">Changes are saved when you click Save.</div>
          </div>
        </div>
      </div>
    </main>

    <!-- PANE C: KYC DATA -->
    <section class="kyc-pane">
      <div id="kyc-empty-state" class="kyc-empty">
        <h3 class="kyc-empty-title">{reply} Overview</h3>
        <p class="kyc-empty-text">Select a contact from the sidebar to view their profile and history.</p>
        <div class="kyc-tip">
          <div class="kyc-tip-label">Quick Tip</div>
          <div class="kyc-tip-text">You can search contacts by name or handle.</div>
        </div>
      </div>

      <div id="kyc-content-editor" class="kyc-editor" style="display:none;">
        <div class="kyc-editor-header">
          <h3 class="kyc-editor-title">Profile</h3>
          <div class="kyc-editor-actions">
            <button id="btn-deep-analyze" class="btn btn-secondary btn-sm" title="Run Deep Analysis with Ollama">âœ¨ Analyze</button>
            <button class="btn btn-primary btn-sm" onclick="saveInlineProfile()">Save</button>
          </div>
        </div>

        <div class="kyc-card">
          <div class="kyc-field">
            <label class="kyc-field-label" for="kyc-name-input">Display Name</label>
            <input id="kyc-name-input" class="kyc-field-input kyc-field-input--title" autocomplete="off">
          </div>

          <div class="kyc-field">
            <label class="kyc-field-label" for="kyc-role-input">Profession</label>
            <input id="kyc-role-input" class="kyc-field-input" autocomplete="off">
          </div>

          <div class="kyc-field">
            <label class="kyc-field-label" for="kyc-rel-input">Relationship</label>
            <input id="kyc-rel-input" class="kyc-field-input" autocomplete="off">
          </div>

          <div class="kyc-field">
            <label class="kyc-field-label" for="kyc-handle-input">Handle</label>
            <input id="kyc-handle-input" class="kyc-field-input kyc-field-input--mono" readonly>
          </div>
        </div>

        <div class="kyc-card">
          <div class="kyc-section">
            <div class="kyc-section-label">Channels</div>
            <div id="kyc-channels" class="kyc-section-body">
              <!-- Channels injected here -->
            </div>
          </div>

          <div class="kyc-section">
            <div class="kyc-section-label">AI Suggestions</div>
            <div id="kyc-suggestions" class="kyc-section-body">
              <!-- Suggestions injected here -->
            </div>
          </div>
        </div>

        <div class="kyc-card">
          <div class="kyc-section">
            <div class="kyc-section-label">Local Intelligence</div>
            <div id="notes-log" class="kyc-notes-log">
              <!-- Notes injected here -->
            </div>
            <div class="kyc-note-add">
              <input id="new-note-input" class="kyc-note-input" placeholder="Add a new observation...">
              <button class="btn btn-primary btn-icon btn-icon-sm" onclick="addNote()" title="Add note">+</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">Edit Contact Profile</h3>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Name:</label>
        <input id="prof-name" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Profession:</label>
        <input id="prof-role" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 0.5rem;">
        <label style="font-size:0.8rem; color:#666;">Relationship:</label>
        <input id="prof-rel" style="width:100%; padding:0.4rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="font-size:0.8rem; color:#666;">Notes:</label>
        <textarea id="prof-notes"
          style="width:100%; height:60px; padding:0.4rem; border:1px solid #ccc; border-radius:4px;"></textarea>
      </div>
      <input type="hidden" id="prof-handle">
      <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
        <button onclick="closeProfileModal()"
          style="background:#eee; color:#333; border:1px solid #ccc; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Cancel</button>
        <button onclick="saveProfile()"
          style="background:#056; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Save
          Profile</button>
      </div>
    </div>
  </div>

  <!-- Application Modules (ES6) -->
  <script type="module" src="js/app.js"></script>
</body>

</html>
